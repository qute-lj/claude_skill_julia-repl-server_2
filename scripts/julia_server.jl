# Julia æœåŠ¡å™¨ - é€šè¿‡æ–‡ä»¶ä¸Claude Codeé€šä¿¡
# å¯åŠ¨æ–¹å¼: julia --project=. julia_server.jl

using Revise, Plots, DataFrames, CSV, BenchmarkTools, FFTW, ITensors
using Dates, Random  # æ–°å¢ - ç”¨äºç”Ÿæˆå”¯ä¸€IDå’Œæ—¶é—´æˆ³

# ç”Ÿæˆå”¯ä¸€æœåŠ¡å™¨ID
SERVER_ID = "julia_repl_$(getpid())_$(rand(1000:9999))"
println("ğŸ¤– Julia æœåŠ¡å™¨å·²å¯åŠ¨ (ID: $SERVER_ID)")

# åˆ›å»ºé€šä¿¡ç›®å½•ï¼ˆä½¿ç”¨ç³»ç»Ÿä¸´æ—¶ç›®å½•ï¼‰
COMM_DIR = mktempdir(prefix="julia_repl_")
COMMAND_FILE = joinpath(COMM_DIR, "command.txt")
RESPONSE_FILE = joinpath(COMM_DIR, "response.txt")

# å°†é…ç½®ä¿¡æ¯ä¿å­˜åˆ°ç”¨æˆ·ä¸»ç›®å½•çš„é…ç½®æ–‡ä»¶ä¸­
CONFIG_PATH = joinpath(homedir(), ".julia_repl_server_config.jl")

# è½¬æ¢è·¯å¾„ä¸ºæ­£æ–œæ æ ¼å¼ï¼Œé¿å…Juliaè§£æé”™è¯¯
function normalize_path(path::String)
    return replace(path, "\\" => "/")
end

open(CONFIG_PATH, "w") do f
    println(f, "# Julia REPL Server Configuration")
    println(f, "# Generated by JuliaREPLServer on $(now())")
    println(f, "SERVER_ID = \"$(SERVER_ID)\"")
    println(f, "COMMAND_FILE = \"$(normalize_path(COMMAND_FILE))\"")
    println(f, "RESPONSE_FILE = \"$(normalize_path(RESPONSE_FILE))\"")
    println(f, "COMM_DIR = \"$(normalize_path(COMM_DIR))\"")
    println(f, "START_TIME = \"$(now())\"")
end

println("ğŸ’¾ é…ç½®æ–‡ä»¶å·²ä¿å­˜: $CONFIG_PATH")

println("ğŸ“¦ æ‰€æœ‰åŒ…å·²åŠ è½½")
println("ğŸ”„ Revise çƒ­é‡è½½å·²æ¿€æ´»")
println("ğŸ“¡ é€šä¿¡ç›®å½•: $COMM_DIR")
println("ğŸ”‘ æœåŠ¡å™¨ID: $SERVER_ID")
println("=" ^ 50)

# æ³¨æ„ï¼šç”±äºä½¿ç”¨ç³»ç»Ÿä¸´æ—¶ç›®å½•å’Œå”¯ä¸€IDï¼Œæ— éœ€åˆ é™¤æ—§æ–‡ä»¶
# mktempdir() ä¼šåˆ›å»ºå…¨æ–°çš„ä¸´æ—¶ç›®å½•

# å‘½ä»¤å¤„ç†å‡½æ•° - å¢å¼ºç‰ˆ
function process_command(command)
    try
        # è®°å½•æ”¶åˆ°çš„åŸå§‹å‘½ä»¤
        println("ğŸ“ æ”¶åˆ°åŸå§‹å‘½ä»¤: $(repr(command))")

        # æ¸…ç†å‘½ä»¤ï¼ˆç§»é™¤å¤šä½™ç©ºç™½ï¼‰
        cleaned_command = strip(command)
        println("ğŸ§¹ æ¸…ç†åå‘½ä»¤: $(repr(cleaned_command))")

        if startswith(cleaned_command, "include(")
            # å¤„ç†æ–‡ä»¶åŒ…å«å‘½ä»¤
            println("ğŸ“‚ å¤„ç†æ–‡ä»¶åŒ…å«å‘½ä»¤")
            eval(Meta.parse(cleaned_command))
            return "âœ… æ–‡ä»¶åŠ è½½æˆåŠŸ"
        else
            # å°è¯•æ‰§è¡Œä»»æ„Juliaä»£ç 
            println("âš¡ æ‰§è¡ŒJuliaä»£ç ")
            parsed_expr = Meta.parse(cleaned_command)
            println("ğŸ” è§£æç»“æœ: $(repr(parsed_expr))")

            result = eval(parsed_expr)
            result_str = string(result)
            println("ğŸ’» æ‰§è¡Œç»“æœç±»å‹: $(typeof(result))")

            # é™åˆ¶ç»“æœé•¿åº¦ï¼Œé¿å…è¿‡é•¿çš„å“åº”
            if length(result_str) > 500
                result_str = result_str[1:497] * "..."
            end

            return "âœ… æ‰§è¡ŒæˆåŠŸ: $result_str"
        end
    catch e
        # æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
        error_msg = string(e)
        println("âŒ é”™è¯¯è¯¦æƒ…: $error_msg")

        # æä¾›å¸¸è§é”™è¯¯çš„è§£å†³å»ºè®®
        if occursin("syntax", lowercase(error_msg))
            error_msg *= "\nğŸ’¡ å»ºè®®: æ£€æŸ¥Juliaè¯­æ³•ï¼Œç‰¹åˆ«æ˜¯å¼•å·å’Œæ‹¬å·çš„åŒ¹é…"
        elseif occursin("UndefVarError", error_msg)
            error_msg *= "\nğŸ’¡ å»ºè®®: å˜é‡æœªå®šä¹‰ï¼Œè¯·å…ˆå®šä¹‰æˆ–åŠ è½½ç›¸åº”çš„åŒ…"
        elseif occursin("MethodError", error_msg)
            error_msg *= "\nğŸ’¡ å»ºè®®: æ–¹æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥å‡½æ•°å‚æ•°å’Œç±»å‹"
        end

        return "âŒ é”™è¯¯: $error_msg"
    end
end


# ä¸»å¾ªç¯ - ç›‘å¬å‘½ä»¤æ–‡ä»¶
println("ğŸ¯ æœåŠ¡å™¨å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…å‘½ä»¤...")
println("ğŸ’¡ å‘ $COMMAND_FILE å†™å…¥å‘½ä»¤å³å¯æ‰§è¡Œ")

while true
    sleep(0.1)  # æ¯0.1ç§’æ£€æŸ¥ä¸€æ¬¡ï¼ˆä»0.5ç§’ä¼˜åŒ–åˆ°0.1ç§’ï¼Œæé«˜å“åº”é€Ÿåº¦ï¼‰

    if isfile(COMMAND_FILE)
        # è¯»å–å‘½ä»¤
        command = strip(read(COMMAND_FILE, String))

        if !isempty(command)
            println("ğŸ“¨ æ”¶åˆ°å‘½ä»¤: $command")

            # å¤„ç†å‘½ä»¤
            response = process_command(command)
            println("ğŸ“¤ å“åº”: $response")

            # å†™å…¥å“åº”
            open(RESPONSE_FILE, "w") do f
                write(f, response)
            end

            # åˆ é™¤å‘½ä»¤æ–‡ä»¶
            rm(COMMAND_FILE)

            println("âœ… å‘½ä»¤å¤„ç†å®Œæˆ")
        end
    end
end